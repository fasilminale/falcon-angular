<div [formGroup]="_formGroup">
  <!--Invoice amount div starts-->
  <span class="headline2">Invoice amount</span>
  <div class="invoice-amount-div row px-1">
    <!-- INVOICE AMOUNT -->
    <div class="col-2">
      <label for="invoice-amount-input" class="fal-label">
        Invoice Net Amount
      </label>
      <app-fal-currency-input id="invoice-amount-input"
                              formControlName="amountOfInvoice"
                              [isDisabled]="readOnlyForm"
                              [isError]="!_formGroup.get('amountOfInvoice')?.value"
                              *ngIf="isPrepaid"
      >
      </app-fal-currency-input>
      <input class="form-control input_na" disabled type="text" value="N/A" *ngIf="!isPrepaid">

      <small class="error-text col-2" *ngIf="!_formGroup.get('amountOfInvoice')?.value && isPrepaid"
             [ngClass]="{ 'mt-3' : true }">
        Invoice Net Amount is missing
      </small>
    </div>

    <!-- CURRENCY -->
    <div class="col-2 px-4 currency-div">
      <label for="currency-input" class="fal-label">
        Currency
      </label>
      <elm-radio-input id="currency-input"
                       orientation="horizontal"
                       formControlName="currency"
                       [options]="currencyOptions"
                       [ngClass]="{'radio-dev-disabled': readOnlyForm}"
                       [errorSpacing]="true">
      </elm-radio-input>
    </div>

    <div *ngIf="hasMileage" class="col-2">
      <label for="mileage" class="fal-label">
        Mileage
      </label>
      <input id="mileage"
             class="form-control"
             formControlName="mileage"
             [attr.disabled]="readOnlyForm? '': null"
      />

    </div>

    <!-- OVERRIDE STANDARD PAYMENT TERMS -->
    <div class="col-4 offset-md-2 d-flex" [formGroup]="overridePaymentTermsFormGroup">
      <elm-checkbox-input id="override-stp-checkbox"
                          orientation="horizontal"
                          formArrayName="isPaymentOverrideSelected"
                          checkboxStyle="checkbox"
                          [errorSpacing]="false"
                          [options]="overridePaymentTermsOptions"
                          [attr.disabled]="readOnlyForm ? true : null"></elm-checkbox-input>
      <div class="payment-terms-div">
        <label class="fal-label">Payment terms</label>
        <ng-select id="paymentTerms"
                   formControlName="paymentTerms"
                   [items]="paymentTermOptions"
                   bindLabel="display"
                   bindValue="value"
                   [readonly]="readOnlyForm || isPaymentOverrideSelected.length === 0"
                   placeholder="Select One...">
        </ng-select>
      </div>

    </div>

  </div>
  <!--Invoice amount div ends-->


  <!--new change starts--> <!--cost breakdown div starts-->
  <div class="cost-breakdown-div my-3" formArrayName="costBreakdownItems">
    <div class="col-12">Cost breakdown</div>
    <div class="row my-3 mx-0 cost-breakdown-item-header">
      <div class="col-3">Charge</div>
      <div class="col-1">Rate Source</div>
      <div class="col-2">Rate</div>
      <div class="col-2">Type</div>
      <div class="col-2">Quantity</div>
      <div class="col-2">Total</div>
    </div>
    <ng-container *ngIf="costBreakdownItemsControls && costBreakdownItemsControls.length > 0 && isPrepaid">
      <div *ngFor="let _ of costBreakdownItemsControls; index as i"
           class="row"
           [ngClass]="{ 'cost-breakdown-item-row' : _.get('message')?.value !== 'NOT FOUND' }"
           [formGroupName]="i">

        <!-- Cost breakdown item- Charge -->
        <div class="col-3" *ngIf="_.get('contracted')?.value">
          <input type="text"
                 class="form-control"
                 formControlName="charge"
                 maxlength="4"
                 [attr.disabled]="readOnlyForm ? '': null"
                 [ngClass]="{ 'error-div' : _.get('message')?.value === 'NOT FOUND' }"
          />
          <small class="error-text"
                 *ngIf="_.get('message')?.value === 'NOT FOUND'">
            Charge not found
          </small>
        </div>

        <div class="col-3" *ngIf="!_.get('contracted')?.value">
          <elm-text-input id="chargeField"
                          formControlName="charge">
          </elm-text-input>
        </div>

        <div class="col-1">
          <input type="text"
                 class="form-control"
                 formControlName="rateSource"
                 [attr.disabled]="readOnlyForm ? '': null"
          />
        </div>

        <!-- Cost breakdown item - Rate -->
        <div class="col-2">
          <input type="text"
                 class="form-control text-right"
                 formControlName="rate"
                 [attr.disabled]="readOnlyForm ? '': null"
          />
        </div>

        <!-- Cost breakdown item - Type -->
        <div class="col-2">
          <input type="text"
                 class="form-control"
                 formControlName="type"
                 [attr.disabled]="readOnlyForm ? '' : null"
          />
        </div>

        <!-- Cost breakdown item - Quantity -->
        <div class="col-2">
          <input type="text"
                 class="form-control"
                 formControlName="quantity"
                 maxlength="10"
                 [attr.disabled]="readOnlyForm ? '': null"
          />
        </div>

        <!-- Cost breakdown item - totalAmount -->
        <div class="col-2">
          <app-fal-currency-input
            [isError]="_.get('charge')?.value === 'Base Rate' && _.get('totalAmount')?.value === 0"
            formControlName="totalAmount"
            [isDisabled]="readOnlyForm"
          >

          </app-fal-currency-input>

          <small class="error-text"
                 *ngIf="_.get('charge')?.value === 'Base Rate' && _.get('totalAmount')?.value === 0">
            Base Rate Amount is required
          </small>
        </div>

      </div>
    </ng-container>
    <elm-button buttonType="button"
                buttonStyle="text"
                id="add-new-line-item-button"
                [isDisabled]="readOnlyForm"
                (buttonClick)="onAddChargeButtonClick()">
      <u>+ Add New Charge</u>
    </elm-button>

    <div [class.error-div]="!isValidCostBreakdownAmount"
         class="border-radius-5 cost-breakdown-total-div mt-5 mb-2 p-3 offset-md-9"
         *ngIf="costBreakdownItemsControls && costBreakdownItemsControls.length > 0 && isPrepaid">
      <div class="row">
        <div class="row d-flex justify-content-between">
          <span class="px-3 col-md-8 text-right">Contracted Rate Total:</span>
          <span class="col-md-4 text-right p-0">{{ contractedRateTotal | currency}}</span>
        </div>
        <div class="row d-flex justify-content-between">
          <span class="px-3 col-md-8 text-right">Non-Contracted Rate Total:</span>
          <span class="col-md-4 text-right p-0">{{ nonContractedRateTotal | currency}}</span>
        </div>
        <div class="row d-flex justify-content-between">
          <span class="px-3 col-md-8 text-right text-bold">Cost Breakdown Total:</span>
          <span class="col-md-4 text-right text-bold p-0">{{ costBreakdownTotal | currency}}</span>
        </div>
      </div>
    </div>
    <small class="error-text col-3 offset-md-9 mt-3" *ngIf="!isValidCostBreakdownAmount">
      Cost Breakdown Total must equal Invoice Net Amount
    </small>
  </div>

  <div class="cost-breakdown-div my-3" formArrayName="disputeLineItems">
    <div class="col-12">Disputes</div>
    <div class="row my-3 mx-0 dispute-item-header">
      <div class="col-2">Carrier Comments</div>
      <div class="col-1">Attachment</div>
      <div class="col-1">Creation Date</div>
      <div class="col-1">Created By</div>
      <div class="col-1">Response Status</div>
      <div class="col-2">Response Comments</div>
      <div class="col-1">Closed Date</div>
      <div class="col-1">Closed By</div>
      <div class="col-2 action-label">Actions</div>
    </div>
    <ng-container *ngIf="disputeLineItemControls && disputeLineItemControls.length > 0 && isPrepaid">
      <div *ngFor="let _ of disputeLineItemControls; index as i"
           class="row dispute-item-row"
           [formGroupName]="i">

        <!-- Dispute Line Item - Carrier Comment -->
        <div class="col-2">
          <textarea id="comment"
                    formControlName="comment"
                    class="form-control"
                    readonly
          ></textarea>
        </div>

        <!-- Dispute Line Item - Attachments -->
        <div class="col-1">
          <div class="material-icons download-icon">file_download</div>
          <span [matTooltipPosition]="'below'"
                [matTooltip]="'Download Attachment'"
                [ngStyle]="{'font-size':'15px', 'vertical-align':'text-top'}"
                matTooltipClass="newLine">Download</span>
        </div>

        <!-- Dispute Line Item - Created Date -->
        <div class="col-1">
          {{_.value.createdDate | date: dateFormat}}
        </div>

        <!-- Dispute Line Item - Created By -->
        <div class="col-1 dispute-item-row">
          <span *ngIf="_.value.createdBy?.length > ellipsisPipeLimit"
                [matTooltipPosition]="'below'"
                [matTooltip]="_.value.createdBy"
                [ngStyle]="{'font-size':'15px', 'vertical-align':'text-top'}"
                matTooltipClass="newLine">{{_.value.createdBy | ellipsisPipe:ellipsisPipeLimit}}</span>
          <span *ngIf="_.value.createdBy?.length <= ellipsisPipeLimit">
            {{_.value.createdBy || 'N/A'}}
          </span>
        </div>

        <!-- Dispute Line Item - Response Status -->
        <div class="col-1">
          {{_.value.disputeStatus?.label || 'N/A'}}
        </div>

        <!-- Dispute Line Item - Response Comment -->
        <div class="col-2">
          <textarea id="response-comment"
                    formControlName="responseComment"
                    class="form-control"
                    readonly
          ></textarea>
        </div>

        <!-- Dispute Line Item - Closed Date -->
        <div class="col-1">
          {{(_.value.closedDate | date: dateFormat) || 'N/A'}}
        </div>

        <!-- Dispute Line Item - Closed By -->
        <div class="col-1">
          <span *ngIf="_.value.closedBy?.length > ellipsisPipeLimit"
                [matTooltipPosition]="'below'"
                [matTooltip]="_.value.closedBy"
                [ngStyle]="{'font-size':'15px', 'vertical-align':'text-top'}"
                matTooltipClass="newLine">{{_.value.closedBy | ellipsisPipe:ellipsisPipeLimit}}</span>
          <span *ngIf="_.value.closedBy?.length <= ellipsisPipeLimit">
            {{_.value.closedBy || 'N/A'}}
          </span>
        </div>

        <div class="col-2">
          <span *ngIf="_.value.disputeStatus.key === 'OPEN'">
            <elm-button buttonType="button"
                        buttonStyle="text"
                        [padding]="'0 10px'"
                        id="dispute-accept-button"
                        [isDisabled]="readOnlyForm"
                        (buttonClick)="resolveDispute('Accept')">
              <span>Accept</span>
            </elm-button>
            <elm-button buttonType="button"
                        buttonStyle="text"
                        [padding]="'0 10px'"
                        id="dispute-deny-button"
                        [isDisabled]="readOnlyForm"
                        (buttonClick)="resolveDispute('Deny')">
              <span>Deny</span>
            </elm-button>
          </span>

        </div>
      </div>

    </ng-container>
    <div class="no-results" *ngIf="disputeLineItemControls && disputeLineItemControls.length == 0">
      No disputes
    </div>
  </div>

  <div class="no-results" *ngIf="!isPrepaid">
    No rates available
  </div>
</div>

